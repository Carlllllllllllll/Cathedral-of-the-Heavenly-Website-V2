<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ† â€“ Â«Ø§ÙÙÙ’Ø±ÙØ­ÙÙˆØ§ ÙÙÙŠ Ø§Ù„Ø±Ù‘ÙØ¨Ù‘Ù ÙƒÙÙ„Ù‘Ù Ø­ÙÙŠÙ†ÙÂ» (ÙÙŠÙ„Ø¨ÙŠ Ù¤: Ù¤)" />
  <meta name="keywords" content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ† â€“ Â«Ø§ÙÙÙ’Ø±ÙØ­ÙÙˆØ§ ÙÙÙŠ Ø§Ù„Ø±Ù‘ÙØ¨Ù‘Ù ÙƒÙÙ„Ù‘Ù Ø­ÙÙŠÙ†ÙÂ» (ÙÙŠÙ„Ø¨ÙŠ Ù¤: Ù¤)" />
  <meta name="author" content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†" />
  <meta name="theme-color" content="#402958" />
  <meta name="robots" content="noindex, nofollow" />
  <meta property="og:title" content="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± | ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†" />
  <meta property="og:description" content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ† â€“ Â«Ø§ÙÙÙ’Ø±ÙØ­ÙÙˆØ§ ÙÙÙŠ Ø§Ù„Ø±Ù‘ÙØ¨Ù‘Ù ÙƒÙÙ„Ù‘Ù Ø­ÙÙŠÙ†ÙÂ» (ÙÙŠÙ„Ø¨ÙŠ Ù¤: Ù¤)" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary" />
  <title>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± | ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†</title>
  <link rel="icon" href="/UI/icon.png" type="image/png" sizes="16x16" />
  <link rel="apple-touch-icon" href="/UI/icon.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="stylesheet" href="/design/theme.css" />
  <link rel="stylesheet" href="/design/app.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .auth-shell {
      max-width: 500px;
    }

    .swal2-loader {
      border-color: #ffcc00 transparent #ffcc00 transparent !important;
    }

    .swal2-container {
      z-index: 20000 !important;
    }

    .auth-shell {
      flex: 1;
    }

    #resetForm {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #resetForm button {
      width: 100%;
    }

    .password-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      margin-top: 1.5rem;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: var(--accent);
    }
  </style>
</head>

<body>
  <nav class="nav-container">
    <div class="nav-bar">
      <div class="nav-left">
        <div class="nav-logo-container">
          <img src="/UI/logo.png" alt="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†" class="nav-logo" />
        </div>
      </div>
      <div class="nav-right"></div>
    </div>
  </nav>

  <div class="auth-shell">
    <section class="login-panel">
      <h2 id="resetPageTitle">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
      <p>
        Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ. ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰
        Ø§Ù„Ø£Ù‚Ù„ØŒ ÙˆØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØ±Ù…Ø² ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.
      </p>

      <div id="resetCard">
        <form id="resetForm">
          <div class="form-group">
            <label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
            <div style="position: relative;">
              <input type="password" id="newPassword" name="newPassword" required minlength="8" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                autocomplete="new-password" />
            </div>
            <span class="password-hint">8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ØŒ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØ§Ø­Ø¯ØŒ ÙˆØ±Ù…Ø² ÙˆØ§Ø­Ø¯ (!@#$%^&*)</span>
          </div>
          <div class="form-group">
            <label for="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div style="position: relative;">
              <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
            </div>
          </div>
          <button type="submit" id="submitBtn">
            <i class="fas fa-check"></i>
            Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          </button>
        </form>

        <a href="/login" class="back-link">
          <i class="fas fa-arrow-right"></i>
          <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
        </a>
      </div>
    </section>
  </div>

  <footer>
    <p>&copy; 2026 ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/scripts/utils.js"></script>
  <script>
    const translateAuthError = (rawMessage) => {
      const fallback = "Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
      if (!rawMessage || typeof rawMessage !== 'string') return fallback;
      const msg = rawMessage.trim();
      if (!msg) return fallback;
      const lower = msg.toLowerCase();
      if (lower.includes('too many') || lower.includes('rate') || lower.includes('limit')) {
        return 'ØªÙ… ØªÙ†ÙÙŠØ° Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
      }
      if (lower.includes('invalid') && (lower.includes('token') || lower.includes('link'))) {
        return 'Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.';
      }
      if (lower.includes('network') || lower.includes('failed to fetch')) {
        return 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
      }
      return msg;
    };

    const RESET_LOCAL_STORAGE_KEY = 'resetPasswordDeviceState:v1';

    const readResetLocalState = () => {
      try {
        const raw = window.localStorage.getItem(RESET_LOCAL_STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch (e) {
        return {};
      }
    };

    const writeResetLocalState = (next) => {
      try {
        if (!next || typeof next !== 'object') {
          window.localStorage.removeItem(RESET_LOCAL_STORAGE_KEY);
          return;
        }
        window.localStorage.setItem(RESET_LOCAL_STORAGE_KEY, JSON.stringify(next));
      } catch (e) {}
    };

    const getLocalVerifiedForToken = (token) => {
      const state = readResetLocalState();
      const entry = state && token ? state[token] : null;
      if (!entry || typeof entry !== 'object') return null;
      const code = (entry.code || '').toString().replace(/\D/g, '').slice(0, 6);
      if (code.length !== 6) return null;
      return { code };
    };

    const setLocalVerifiedForToken = (token, code) => {
      if (!token) return;
      const cleanCode = (code || '').toString().replace(/\D/g, '').slice(0, 6);
      if (cleanCode.length !== 6) return;
      const state = readResetLocalState();
      state[token] = { code: cleanCode, savedAt: new Date().toISOString() };
      writeResetLocalState(state);
    };

    const clearLocalVerifiedForToken = (token) => {
      if (!token) return;
      const state = readResetLocalState();
      if (state && Object.prototype.hasOwnProperty.call(state, token)) {
        delete state[token];
        if (Object.keys(state).length === 0) {
          writeResetLocalState(null);
        } else {
          writeResetLocalState(state);
        }
      }
    };

    const pathParts = window.location.pathname.split('/');
    const token = (pathParts[pathParts.length - 1] || '').trim();
    const card = document.getElementById('resetCard');
    const pageTitleEl = document.getElementById('resetPageTitle');
    const formEl = document.getElementById('resetForm');
    const submitBtn = document.getElementById('submitBtn');
    let isVerified = false;

    const showBlockingLoader = (message) => {
      let overlay = document.getElementById('resetBlockingLoader');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'resetBlockingLoader';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.zIndex = '99999';
        overlay.style.background = 'rgba(0,0,0,0.78)';
        overlay.style.backdropFilter = 'blur(10px)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.padding = '24px';

        const box = document.createElement('div');
        box.style.background = '#2a1b3c';
        box.style.border = '1px solid rgba(255, 204, 0, 0.35)';
        box.style.borderRadius = '16px';
        box.style.padding = '18px 18px 16px';
        box.style.maxWidth = '420px';
        box.style.width = '100%';
        box.style.textAlign = 'center';
        box.style.color = '#f2f4ff';

        const spinner = document.createElement('div');
        spinner.style.width = '54px';
        spinner.style.height = '54px';
        spinner.style.margin = '0 auto 14px';
        spinner.style.border = '4px solid rgba(255, 204, 0, 0.25)';
        spinner.style.borderTopColor = '#ffcc00';
        spinner.style.borderRadius = '50%';
        spinner.style.animation = 'resetSpin 0.9s linear infinite';

        const text = document.createElement('div');
        text.id = 'resetBlockingLoaderText';
        text.style.fontWeight = '800';
        text.style.letterSpacing = '0.2px';
        text.textContent = message || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

        const sub = document.createElement('div');
        sub.style.marginTop = '6px';
        sub.style.color = 'rgba(242, 244, 255, 0.75)';
        sub.style.fontSize = '13px';
        sub.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';

        box.appendChild(spinner);
        box.appendChild(text);
        box.appendChild(sub);
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        if (!document.getElementById('resetSpinStyle')) {
          const style = document.createElement('style');
          style.id = 'resetSpinStyle';
          style.textContent = '@keyframes resetSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}';
          document.head.appendChild(style);
        }
      } else {
        const text = document.getElementById('resetBlockingLoaderText');
        if (text) text.textContent = message || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        overlay.style.display = 'flex';
      }
    };

    const hideBlockingLoader = () => {
      const overlay = document.getElementById('resetBlockingLoader');
      if (overlay) overlay.style.display = 'none';
    };

    const setTitlesWithUsername = (username) => {
      const clean = (username || '').toString().trim();
      if (!clean) return;

      const safeName = clean.replace(/</g, '&lt;').replace(/>/g, '&gt;');

      if (pageTitleEl) {
        pageTitleEl.textContent = `ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù€ (${clean})`;
      }

      document.title = `ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù€ (${clean}) | ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†`;

      const ogTitle = document.querySelector('meta[property="og:title"]');
      if (ogTitle) {
        ogTitle.setAttribute('content', `ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù€ (${clean}) | ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†`);
      }
    };

    const ensureSwal = async () => {
      if (window.Swal && typeof window.Swal.fire === 'function') return window.Swal;
      try {
        await new Promise((resolve, reject) => {
          const existing = document.querySelector('script[data-swal-loader="1"]');
          if (existing) {
            existing.addEventListener('load', resolve, { once: true });
            existing.addEventListener('error', reject, { once: true });
            return;
          }
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
          script.async = true;
          script.setAttribute('data-swal-loader', '1');
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      } catch (e) {}
      return window.Swal;
    };

    const ensureInlineErrorEl = () => {
      if (!formEl) return null;
      let el = document.getElementById('resetInlineError');
      if (el) return el;
      el = document.createElement('div');
      el.id = 'resetInlineError';
      el.style.marginTop = '12px';
      el.style.padding = '10px 12px';
      el.style.borderRadius = '10px';
      el.style.background = 'rgba(231, 76, 60, 0.12)';
      el.style.border = '1px solid rgba(231, 76, 60, 0.35)';
      el.style.color = '#ff7a8a';
      el.style.fontWeight = '700';
      el.style.display = 'none';
      formEl.appendChild(el);
      return el;
    };

    const showInlineError = (message) => {
      const el = ensureInlineErrorEl();
      if (!el) return;
      el.textContent = message || 'Ø­Ø¯Ø« Ø®Ø·Ø£.';
      el.style.display = 'block';
    };

    const clearInlineError = () => {
      const el = document.getElementById('resetInlineError');
      if (!el) return;
      el.textContent = '';
      el.style.display = 'none';
    };

    const setFormEnabled = (enabled) => {
      if (!formEl) return;
      Array.from(formEl.querySelectorAll('input, button')).forEach((node) => {
        if (node && node.id === 'submitBtn') {
          node.disabled = !enabled;
          return;
        }
        if (node) node.disabled = !enabled;
      });
    };

    const showInvalidView = (message) => {
      if (!card) return;
      card.innerHTML =
        '<div class="invalid-token">' +
        '<i class="fas fa-link-slash"></i>' +
        '<h3>Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­</h3>' +
        '<p>' + (message || 'Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.') + '</p>' +
        '<a href="/login" class="back-link" style="margin-top:16px;display:inline-flex;">' +
        '<i class="fas fa-arrow-right"></i>' +
        '<span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>' +
        '</a>' +
        '</div>';
    };

    const verifyModal = async (username) => {
      const SwalApi = await ensureSwal();
      if (!SwalApi || typeof SwalApi.fire !== 'function') {
        const code = window.prompt('Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…');
        return (code || '').toString().replace(/\D/g, '').slice(0, 6);
      }
      const res = await SwalApi.fire({
        title: 'ğŸ”‘ ØªØ£ÙƒÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚',
        html: `<p style="margin-bottom: 14px; color: #f2f4ff; font-size: 14px;">Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚Ø¨Ù„ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·.</p>${username ? `<div style="margin-bottom:10px; color:#ffcc00; font-weight:800;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span dir="ltr">${String(username).replace(/</g, '&lt;')}</span></div>` : ''}<input type="text" id="swal-reset-verify" class="swal2-input" placeholder="123456" maxlength="6" inputmode="numeric" style="text-align:center;font-size:24px;letter-spacing:8px;font-weight:bold;font-family:monospace;color:#ffcc00;border:2px solid #ffcc00;max-width:240px;width:100%;padding:12px;" />`,
        icon: 'info',
        iconColor: '#ffcc00',
        showCloseButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
        confirmButtonColor: '#ffcc00',
        background: '#2a1b3c',
        color: '#f2f4ff',
        backdrop: 'rgba(0,0,0,0.85)',
        showLoaderOnConfirm: true,
        allowOutsideClick: () => !SwalApi.isLoading(),
        allowEscapeKey: () => !SwalApi.isLoading(),
        didOpen: () => {
          const input = document.getElementById('swal-reset-verify');
          if (input) {
            input.focus();
            input.addEventListener('input', function () {
              this.value = this.value.replace(/\D/g, '').slice(0, 6);
            });
          }
        },
        preConfirm: async () => {
          const input = document.getElementById('swal-reset-verify');
          const code = input ? String(input.value || '').replace(/\D/g, '').slice(0, 6) : '';
          if (code.length !== 6) {
            SwalApi.showValidationMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…');
            return false;
          }

          try {
            const vr = await fetch('/api/reset-password/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, code })
            });
            const vd = await vr.json().catch(() => ({}));
            if (!vr.ok || !vd.success) {
              const waitSeconds = typeof parseCooldownSeconds === 'function' ? parseCooldownSeconds(vd.message) : 0;
              if (waitSeconds > 0) {
                SwalApi.showValidationMessage(`ØªÙ… ØªÙ†ÙÙŠØ° Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${waitSeconds} Ø«Ø§Ù†ÙŠØ©.`);
                return false;
              }
              SwalApi.showValidationMessage('ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­');
              return false;
            }
            return code;
          } catch (e) {
            SwalApi.showValidationMessage('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            return false;
          }
        }
      });
      return res.isConfirmed ? res.value : null;
    };

    (async function init() {
      showBlockingLoader('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² ØµÙØ­Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...');
      if (!token || pathParts[pathParts.length - 2] !== 'reset-password') {
        hideBlockingLoader();
        showInvalidView();
        return;
      }

      setFormEnabled(false);
      await ensureSwal();
      try {
        showBlockingLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·...');
        const r = await fetch('/api/reset-password/validate/' + encodeURIComponent(token));
        const d = await r.json().catch(() => ({}));
        if (!d.valid) {
          hideBlockingLoader();
          showInvalidView(translateAuthError(d.message) || 'Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.');
          return;
        }

        if (d.username) {
          setTitlesWithUsername(d.username);
        }

        const localEntry = getLocalVerifiedForToken(token);
        if (!localEntry) {
          showBlockingLoader('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚...');
          hideBlockingLoader();

          const code = await verifyModal(d.username);
          if (!code) {
            showInvalidView('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚.');
            return;
          }
          setLocalVerifiedForToken(token, code);
        }

        isVerified = true;
        setFormEnabled(true);
        hideBlockingLoader();
      } catch (e) {
        hideBlockingLoader();
        showInvalidView('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
        return;
      }
      if (!formEl) return;

      if (typeof attachPasswordToggle === 'function') {
        attachPasswordToggle('newPassword');
        attachPasswordToggle('confirmPassword');
      }

      const enforceNoArabic = (inputId, msg) => {
        const el = document.getElementById(inputId);
        if (!el) return;
        el.addEventListener('input', function () {
          if (typeof containsArabicCharacters === 'function' && containsArabicCharacters(this.value)) {
            this.value = typeof removeArabicCharacters === 'function' ? removeArabicCharacters(this.value) : this.value;
            showInlineError(msg);
          }
        });
      };
      enforceNoArabic('newPassword', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø© ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
      enforceNoArabic('confirmPassword', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø© ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');

      formEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearInlineError();
        if (!isVerified) {
          showInlineError('ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
          return;
        }
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (newPassword !== confirmPassword) {
          showInlineError('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
          return;
        }
        if (newPassword.length < 8) {
          showInlineError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
          return;
        }
        if (!/[A-Z]/.test(newPassword)) {
          showInlineError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
          return;
        }
        if (!/[!@#$%^&*()_+\-=[\]{};':"\\|,.<>\/?]/.test(newPassword)) {
          showInlineError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø² ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (!@#$%...)');
          return;
        }
        const btn = submitBtn;
        if (typeof setButtonLoading === 'function') {
          setButtonLoading(btn, true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
        } else {
          btn.disabled = true;
          btn.innerHTML = '<span class="loading-dots" aria-hidden="true"><span></span><span></span><span></span></span><span style="margin-right:8px">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>';
        }
        try {
          const res = await fetch('/api/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, newPassword })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.success) {
            const SwalApi = await ensureSwal();
            if (SwalApi && typeof SwalApi.fire === 'function') {
              await SwalApi.fire({
              title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­',
              text: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.',
              icon: 'success',
              confirmButtonColor: '#27ae60',
              background: '#2a1b3c',
              color: '#f2f4ff',
              });
            }
            clearLocalVerifiedForToken(token);
            setFormEnabled(false);
          } else {
            const msg = translateAuthError(data.message) || 'ÙØ´Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
            if (msg.includes('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­') || msg.includes('Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©')) {
              showInvalidView(msg);
            } else {
              showInlineError(msg);
              if (typeof setButtonLoading === 'function') {
                setButtonLoading(btn, false);
              } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
              }
            }
          }
        } catch (err) {
          showInlineError(translateAuthError(err.message) || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
          if (typeof setButtonLoading === 'function') {
            setButtonLoading(btn, false);
          } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
          }
        }
      });
    })();
  </script>
</body>

</html>