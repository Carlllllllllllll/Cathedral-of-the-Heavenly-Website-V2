<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#402958" />
    <meta name="robots" content="noindex, nofollow" />
    <title>التحكم المتقدم والمتابعة المباشرة | كاتدرائية السمائيين</title>
    <link rel="icon" href="/UI/icon.png" type="image/png" sizes="16x16" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/design/theme.css" />
    <link rel="stylesheet" href="/design/admin.css" />
    <link rel="stylesheet" href="/design/admin-dashboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"
      defer
    ></script>
    <script src="/scripts/utils.js" defer></script>
    <script src="/scripts/form-panel.js" defer></script>
    <script src="/scripts/sidebar.js" defer></script>
    <script src="/scripts/console.js" defer></script>
    <style>
      .live-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .live-stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        min-width: 140px;
      }
      .live-stat-card .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent, #ffcc00);
      }
      .live-stat-card .label {
        font-size: 0.9rem;
        color: var(--text-muted, #95a5a6);
        margin-top: 0.25rem;
      }
      .live-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
      }
      .live-actions button {
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .live-actions .btn-refresh {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
      }
      .live-actions .btn-clear {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
      }
      .live-actions .btn-clear-guests {
        background: rgba(155, 89, 182, 0.2);
        color: #9b59b6;
      }
      .live-actions button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .sessions-table-wrap,
      .guests-table-wrap {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 1.5rem;
      }
      .sessions-table,
      .guests-table {
        width: 100%;
        border-collapse: collapse;
      }
      .sessions-table th,
      .sessions-table td,
      .guests-table th,
      .guests-table td {
        padding: 0.75rem 1rem;
        text-align: right;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .sessions-table th,
      .guests-table th {
        background: rgba(255, 255, 255, 0.05);
        font-weight: 600;
        color: var(--text);
      }
      .sessions-table tr:hover,
      .guests-table tr:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .badge-live {
        background: #27ae60;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        font-size: 0.8rem;
      }
      .badge-idle {
        color: var(--text-muted);
        font-size: 0.85rem;
      }
      .path-cell {
        font-family: monospace;
        font-size: 0.85rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .live-note {
        margin-top: 0.5rem;
        padding: 0.75rem 1rem;
        background: rgba(255, 204, 0, 0.08);
        border-radius: 8px;
        font-size: 0.9rem;
        color: var(--text);
      }
      .suite-section {
        margin-top: 2rem;
        padding: 1.25rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
      }
      .suite-section h2 {
        margin-bottom: 1rem;
        font-size: 1.1rem;
        color: var(--accent);
      }
      .section-title {
        margin: 1.5rem 0 0.75rem;
        font-size: 1rem;
        color: var(--text);
      }
      body.admin-live .main-content {
        margin-left: 0;
      }
    </style>
  </head>
  <body class="admin-page-form-panel admin-live">
    <main class="main-content">
      <header class="top-nav">
        <div class="user-info">
          <img src="/UI/pfp.jpg" alt="المستخدم" class="user-avatar" />
          <div class="user-details">
            <h3 id="username-display">جاري التحميل...</h3>
            <span id="user-role-pill" class="role-badge">مشرف</span>
          </div>
          <button class="logout-btn-mobile" id="logoutBtnMobile">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </header>
      <div class="admin-container">
        <h1>
          <i class="fas fa-broadcast-tower"></i> التحكم المتقدم والمتابعة
          المباشرة
        </h1>
        <p style="color: var(--text-muted, #95a5a6); margin-bottom: 1rem">
          عرض الجلسات والضيوف والنشاط الحالي (المسار الحالي لكل متصل). صلاحية
          ليد أدمن فقط.
        </p>
        <div class="live-stats">
          <div class="live-stat-card">
            <div class="value" id="stat-total">0</div>
            <div class="label">إجمالي جلسات المستخدمين</div>
          </div>
          <div class="live-stat-card">
            <div class="value" id="stat-live">0</div>
            <div class="label">متصلون الآن (آخر دقيقتين)</div>
          </div>
          <div class="live-stat-card">
            <div class="value" id="stat-guests">0</div>
            <div class="label">الضيوف (آخر 30 دقيقة)</div>
          </div>
          <div class="live-stat-card">
            <div class="value" id="stat-guests-live">0</div>
            <div class="label">ضيوف متصلون الآن</div>
          </div>
        </div>
        <div class="live-actions">
          <button type="button" class="btn-refresh" id="btnRefresh">
            <i class="fas fa-sync-alt"></i> تحديث
          </button>
        </div>
        <div class="section-title">المستخدمون المسجلون (الجلسات)</div>
        <div class="sessions-table-wrap">
          <table class="sessions-table">
            <thead>
              <tr>
                <th>المستخدم</th>
                <th>ID المستخدم</th>
                <th>الحالة</th>
                <th>النشاط الحالي (المسار)</th>
                <th>آخر نشاط</th>
                <th>وقت الدخول</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody id="sessionsBody"></tbody>
          </table>
        </div>
        <div class="section-title">الضيوف (غير المسجلين)</div>
        <div class="guests-table-wrap">
          <table class="guests-table">
            <thead>
              <tr>
                <th>الحالة</th>
                <th>المسار الحالي</th>
                <th>آخر نشاط</th>
                <th>IP</th>
                <th>المتصفح</th>
              </tr>
            </thead>
            <tbody id="guestsBody"></tbody>
          </table>
        </div>
        <div class="suite-section">
          <p style="color: var(--text-muted); margin-bottom: 1rem">
            تسجيل خروج جميع المستخدمين (حتى غير المتصلين) وإزالة سجل الضيوف.
          </p>
          <div class="live-actions">
            <button type="button" class="btn-clear" id="btnClearAll">
              <i class="fas fa-sign-out-alt"></i> تسجيل خروج الكل (إزالة جميع
              الجلسات)
            </button>
            <button type="button" class="btn-clear-guests" id="btnClearGuests">
              <i class="fas fa-user-times"></i> إزالة سجل الضيوف
            </button>
          </div>
        </div>
      </div>
    </main>
    <script>
      (function () {
        async function loadUserInfo() {
          try {
            const response = await fetch("/api/user-info");
            const data = await response.json();
            if (!data.isAuthenticated) {
              window.location.href = "/login";
              return;
            }
            if (data.role !== "leadadmin") {
              window.location.href = "/403";
              return;
            }
            const usernameEl = document.getElementById("username-display");
            const pill = document.getElementById("user-role-pill");
            if (usernameEl) {
              usernameEl.textContent = data.username;
            }
            if (pill) {
              pill.textContent =
                data.role === "leadadmin"
                  ? "ليد أدمن"
                  : data.role === "admin"
                    ? "أدمن"
                    : data.role || "أدمن";
              pill.className = "role-badge role-" + (data.role || "admin");
            }
            document
              .querySelectorAll("[data-nav-access]")
              .forEach(function (el) {
                var key = el.getAttribute("data-nav-access");
                el.style.display = data[key] ? "" : "none";
              });
          } catch (error) {
            console.error("Error fetching user info:", error);
          }
        }

        const handleLogoutClick = async () => {
          const result = await Swal.fire({
            title: "تسجيل الخروج",
            text: "هل تريد فعلاً تسجيل الخروج من النظام؟",
            icon: "question",
            iconColor: "#ffcc00",
            showCancelButton: true,
            confirmButtonText: "نعم، تسجيل خروج",
            cancelButtonText: "إلغاء",
            confirmButtonColor: "#e74c3c",
            cancelButtonColor: "#666",
            background: "#2a1b3c",
            color: "#fff",
            backdrop: "rgba(0,0,0,0.8)",
            allowOutsideClick: false,
          });

          if (result.isConfirmed) {
            try {
              const response = await fetch("/logout", { method: "POST" });
              if (response.ok) {
                await Swal.fire({
                  title: "تم تسجيل الخروج",
                  text: "وداعاً! تم تسجيل خروجك بنجاح",
                  icon: "success",
                  iconColor: "#27ae60",
                  background: "#2a1b3c",
                  color: "#fff",
                  backdrop: "rgba(0,0,0,0.8)",
                  showConfirmButton: false,
                  timer: 1500,
                });
                setTimeout(() => {
                  window.location.href = "/";
                }, 500);
              }
            } catch (error) {
              console.error("Logout error:", error);
              window.location.href = "/";
            }
          }
        };

        const statTotal = document.getElementById("stat-total");
        const statLive = document.getElementById("stat-live");
        const statGuests = document.getElementById("stat-guests");
        const statGuestsLive = document.getElementById("stat-guests-live");
        const sessionsBody = document.getElementById("sessionsBody");
        const guestsBody = document.getElementById("guestsBody");
        const btnRefresh = document.getElementById("btnRefresh");
        const btnClearAll = document.getElementById("btnClearAll");
        const btnClearGuests = document.getElementById("btnClearGuests");
        const sidebar = document.getElementById("sidebar");
        const mobileToggle = document.getElementById("mobileToggle");
        const logoutBtn = document.getElementById("logoutBtn");
        const logoutBtnMobile = document.getElementById("logoutBtnMobile");

        if (mobileToggle && sidebar) {
          mobileToggle.addEventListener("click", function () {
            sidebar.classList.toggle("active");
          });
        }

        if (logoutBtn) {
          logoutBtn.addEventListener("click", handleLogoutClick);
        }
        if (logoutBtnMobile) {
          logoutBtnMobile.addEventListener("click", handleLogoutClick);
        }

        function formatTimeAgo(date) {
          var d = new Date(date);
          var now = new Date();
          var sec = Math.floor((now - d) / 1000);
          if (sec < 60) return "الآن";
          if (sec < 3600) return "منذ " + Math.floor(sec / 60) + " د";
          if (sec < 86400) return "منذ " + Math.floor(sec / 3600) + " س";
          return "منذ " + Math.floor(sec / 86400) + " يوم";
        }

        function loadSessions() {
          fetch("/api/admin/live/sessions", { credentials: "include" })
            .then(function (r) {
              return r.json();
            })
            .then(function (data) {
              if (!data.success) throw new Error(data.message || "فشل التحميل");
              statTotal.textContent = data.count ?? 0;
              statLive.textContent = data.liveCount ?? 0;
              statGuests.textContent = data.guestCount ?? 0;
              statGuestsLive.textContent = data.guestLiveCount ?? 0;
              var sessions = data.sessions || [];
              var rows = sessions.map(function (s) {
                var lastSeen = s.lastSeenAt ? formatTimeAgo(s.lastSeenAt) : "—";
                var loginTime = s.loginTime
                  ? new Date(s.loginTime).toLocaleString("ar-EG")
                  : "—";
                var status = s.isLive
                  ? '<span class="badge-live">متصل الآن</span>'
                  : '<span class="badge-idle">غير نشط</span>';
                var path = s.currentPath
                  ? (s.currentMethod || "") + " " + (s.currentPath || "")
                  : "—";
                var userIdShort =
                  s.userIdShort ||
                  (s.userId ? String(s.userId).substring(0, 8) + "..." : "—");
                return (
                  "<tr>" +
                  "<td>@" +
                  (s.username || "—") +
                  "</td>" +
                  "<td>" +
                  (userIdShort || "—") +
                  "</td>" +
                  "<td>" +
                  status +
                  "</td>" +
                  '<td class="path-cell" title="' +
                  (s.currentPath || "") +
                  '">' +
                  path +
                  "</td>" +
                  "<td>" +
                  lastSeen +
                  "</td>" +
                  "<td>" +
                  loginTime +
                  "</td>" +
                  "<td>" +
                  (s.ip || "—") +
                  "</td>" +
                  "</tr>"
                );
              });
              sessionsBody.innerHTML = rows.length
                ? rows.join("")
                : '<tr><td colspan="7">لا توجد جلسات</td></tr>';
              var guests = data.guests || [];
              var guestRows = guests.map(function (g) {
                var lastSeen = g.lastSeenAt ? formatTimeAgo(g.lastSeenAt) : "—";
                var status = g.isLive
                  ? '<span class="badge-live">متصل الآن</span>'
                  : '<span class="badge-idle">غير نشط</span>';
                var path = g.currentPath
                  ? (g.currentMethod || "") + " " + (g.currentPath || "")
                  : "—";
                return (
                  "<tr><td>" +
                  status +
                  '</td><td class="path-cell" title="' +
                  (g.currentPath || "") +
                  '">' +
                  path +
                  "</td><td>" +
                  lastSeen +
                  "</td><td>" +
                  (g.ip || "—") +
                  "</td><td>" +
                  (g.userAgent || "—") +
                  "</td></tr>"
                );
              });
              guestsBody.innerHTML = guestRows.length
                ? guestRows.join("")
                : '<tr><td colspan="5">لا يوجد ضيوف</td></tr>';
            })
            .catch(function (e) {
              console.error(e);
              sessionsBody.innerHTML =
                '<tr><td colspan="6">حدث خطأ في التحميل</td></tr>';
              if (guestsBody)
                guestsBody.innerHTML = '<tr><td colspan="5">—</td></tr>';
            });
        }

        if (btnRefresh) btnRefresh.addEventListener("click", loadSessions);
        if (btnClearAll)
          btnClearAll.addEventListener("click", function () {
            Swal.fire({
              title: "تسجيل خروج الكل؟",
              text: "سيتم إزالة جميع الجلسات (حتى غير المتصلين). سيحتاج كل المستخدمين لتسجيل الدخول مرة أخرى. هل أنت متأكد؟",
              icon: "warning",
              showCancelButton: true,
              confirmButtonText: "نعم، تسجيل خروج الكل",
              cancelButtonText: "إلغاء",
              confirmButtonColor: "#e74c3c",
            }).then(function (result) {
              if (!result.isConfirmed) return;
              fetch("/api/admin/live/clear-sessions", {
                method: "POST",
                credentials: "include",
              })
                .then(function (r) {
                  return r.json();
                })
                .then(function (data) {
                  if (data.success) {
                    Swal.fire({
                      title: "تم",
                      text:
                        "تم إزالة " + (data.destroyed ?? data.total) + " جلسة.",
                      icon: "success",
                    });
                    loadSessions();
                  } else
                    Swal.fire({
                      title: "خطأ",
                      text: data.message || "فشل",
                      icon: "error",
                    });
                })
                .catch(function (e) {
                  Swal.fire({
                    title: "خطأ",
                    text: e.message || "فشل إزالة الجلسات",
                    icon: "error",
                  });
                });
            });
          });
        if (btnClearGuests)
          btnClearGuests.addEventListener("click", function () {
            Swal.fire({
              title: "إزالة سجل الضيوف؟",
              text: "سيتم حذف قائمة الضيوف الحالية من السجل.",
              icon: "warning",
              showCancelButton: true,
              confirmButtonText: "نعم، إزالة",
              cancelButtonText: "إلغاء",
              confirmButtonColor: "#9b59b6",
            }).then(function (result) {
              if (!result.isConfirmed) return;
              fetch("/api/admin/live/clear-guests", {
                method: "POST",
                credentials: "include",
              })
                .then(function (r) {
                  return r.json();
                })
                .then(function (data) {
                  if (data.success) {
                    Swal.fire({
                      title: "تم",
                      text: "تم إزالة سجل الضيوف.",
                      icon: "success",
                    });
                    loadSessions();
                  } else
                    Swal.fire({
                      title: "خطأ",
                      text: data.message || "فشل",
                      icon: "error",
                    });
                })
                .catch(function (e) {
                  Swal.fire({
                    title: "خطأ",
                    text: e.message || "فشل",
                    icon: "error",
                  });
                });
            });
          });

        loadUserInfo().then(loadSessions);

        setInterval(loadSessions, 5000);
      })();
    </script>
  </body>
</html>
