const e=document.getElementById("mobileToggle"),n=document.getElementById("sidebar"),t=document.getElementById("logoutBtn"),s=document.getElementById("logoutBtnMobile"),a=document.getElementById("usersList"),i=document.getElementById("bannedUsersList"),l=document.getElementById("toggleViewBtn"),o=document.getElementById("refreshUsersBtn"),c=document.getElementById("searchInput"),r=document.getElementById("clearSearch"),d=document.getElementById("usersSection"),u=document.getElementById("bannedSection"),p=document.getElementById("takePointsModal");document.getElementById("takePointsForm");const m=document.getElementById("banModal"),g=document.getElementById("banForm"),f=document.getElementById("editUserModal"),v=document.getElementById("editUserForm");document.getElementById("categoryNav");const y=document.querySelectorAll(".category-tab"),b=document.getElementById("sidebarGradesToggle"),h=document.getElementById("sidebarGradesSubmenu"),w=document.getElementById("closeEditModal"),E=document.getElementById("cancelEditModal");document.getElementById("closeTakePointsModalBtn"),document.getElementById("cancelTakePointsModal");const L=document.getElementById("closeBanModal"),B=document.getElementById("cancelBanModal"),k=document.getElementById("categoryDropdown"),I=document.getElementById("categoryToggle"),$=document.getElementById("dropdownMenu"),T=document.querySelectorAll(".category-option");let x=[],A=[],S="all",M=null,C={all:0,sec1:0,sec2:0,sec3:0,prep1:0,prep2:0,prep3:0,teachers:0,admins:0};function D(t){if(t&&t.preventDefault(),t&&t.stopPropagation(),!n||!e)return;n.classList.toggle("active");const s=e.querySelectorAll("span");n.classList.contains("active")?(s[0].style.transform="rotate(45deg) translate(5px, 5px)",s[1].style.opacity="0",s[2].style.transform="rotate(-45deg) translate(7px, -6px)"):(s[0].style.transform="none",s[1].style.opacity="1",s[2].style.transform="none")}function P(){C={all:x.length,sec1:x.filter(e=>"sec1"===e.grade).length,sec2:x.filter(e=>"sec2"===e.grade).length,sec3:x.filter(e=>"sec3"===e.grade).length,prep1:x.filter(e=>"prep1"===e.grade).length,prep2:x.filter(e=>"prep2"===e.grade).length,prep3:x.filter(e=>"prep3"===e.grade).length,teachers:x.filter(e=>"teachers"===e.grade).length,admins:x.filter(e=>"admins"===e.grade).length};for(const e in C){const n=document.getElementById(`count-${e}`);n&&(n.textContent=C[e])}}e&&n&&(e.addEventListener("click",D),e.addEventListener("touchstart",D));let q=0,H=!1;async function N(e){!1!==e&&(a.innerHTML='\n          <div class="loading-state">\n              <span class="loading-dots" aria-hidden="true"><span></span><span></span><span></span></span>\n              <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>\n          </div>\n      ');try{const e=new URLSearchParams({limit:4,skip:0});S&&"all"!==S&&e.set("grade",S);const n=await fetch("/api/admin/users?"+e.toString());if(!n.ok)throw new Error("HTTP error! status: "+n.status);const t=await n.json(),s=t.users&&Array.isArray(t.users)?t.users:[];q=null!=t.total?t.total:s.length,x=s;const i=await fetch("/api/banned-users"),l=await i.json();A=Array.isArray(l)?l:[];const o=document.getElementById("dashboard-stats");if(o&&(o.innerHTML=`\n              <div class="stat-card stat-success">\n                <div class="stat-icon"><i class="fas fa-user-check"></i></div>\n                <div class="stat-value">${q}</div>\n                <div class="stat-label">Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù†Ø´Ø·ÙˆÙ†</div>\n              </div>\n              <div class="stat-card stat-danger">\n                <div class="stat-icon"><i class="fas fa-user-slash"></i></div>\n                <div class="stat-value">${A.length}</div>\n                <div class="stat-label">Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</div>\n              </div>\n              <div class="stat-card stat-info">\n                <div class="stat-icon"><i class="fas fa-users"></i></div>\n                <div class="stat-value">${q+A.length}</div>\n                <div class="stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>\n              </div>\n            `),0===s.length)return a.innerHTML='\n              <div class="empty-state">\n                  <i class="fas fa-users-slash"></i>\n                  <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù†Ø´Ø·ÙˆÙ†</h3>\n                  <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù†Ø´Ø·ÙˆÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>\n              </div>\n          ',void P();P(),G(x),j()}catch(n){a.innerHTML='\n          <div class="empty-state">\n              <i class="fas fa-exclamation-circle"></i>\n              <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>\n              <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>\n          </div>\n      '}}function j(){if(document.getElementById("users-list-sentinel"))return;const e=document.createElement("div");e.id="users-list-sentinel",e.className="users-list-sentinel",e.setAttribute("aria-hidden","true"),a.appendChild(e);const n=new IntersectionObserver(e=>{e[0].isIntersecting&&async function(){if(H||x.length>=q)return;H=!0;const e=document.getElementById("users-list-sentinel");e&&e.classList.add("loading");try{const n=new URLSearchParams({limit:4,skip:x.length});S&&"all"!==S&&n.set("grade",S);const t=await fetch("/api/admin/users?"+n.toString());if(!t.ok)throw new Error("HTTP "+t.status);const s=await t.json(),a=s.users&&Array.isArray(s.users)?s.users:[];if(0===a.length)return H=!1,void(e&&e.classList.remove("loading"));x=x.concat(a);const i=_(a);e&&e.insertAdjacentHTML("beforebegin",i),P()}catch(n){}finally{H=!1,e&&e.classList.remove("loading")}}()},{root:null,rootMargin:"200px",threshold:0});n.observe(e)}function U(e){let n=x;"all"!==e&&(n=x.filter(n=>n.grade===e)),0===n.length?a.innerHTML='\n          <div class="empty-state">\n              <i class="fas fa-users-slash"></i>\n              <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>\n              <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</p>\n          </div>\n      ':G(n)}function _(e){return(e||[]).map(e=>{const n={prep1:"Ø£ÙˆÙ„ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",prep2:"Ø«Ø§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",prep3:"Ø«Ø§Ù„Ø«Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",sec1:"Ø£ÙˆÙ„ÙŠ Ø«Ø§Ù†ÙˆÙŠ",sec2:"Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ",sec3:"Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ",teachers:"Ø®Ø§Ø¯Ù…",admins:"Ù…Ø´Ø±Ù"}[e.grade]||e.grade,t=null!=e.points?e.points:0,s=t<0?`âˆ’${Math.abs(t)}`:t,a={leadadmin:"Ù„ÙŠØ¯ Ø£Ø¯Ù…Ù†",admin:"Ù…Ø´Ø±Ù",teacher:"Ø®Ø§Ø¯Ù…",student:"Ø·Ø§Ù„Ø¨"}[e.role]||e.role,i=Z(e),l=function(e){const n={online:'<span class="status-badge online-badge">ğŸŸ¢ Ù…ØªØµÙ„</span>',idle:'<span class="status-badge idle-badge">ğŸŸ  ØºÙŠØ± Ù†Ø´Ø·</span>',"signed-in":'<span class="status-badge signed-in-badge">ğŸ”µ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>',"signed-out":'<span class="status-badge signed-out-badge">âš« ØºÙŠØ± Ù…ØªØµÙ„</span>',offline:'<span class="status-badge offline-badge">âš« ØºÙŠØ± Ù…ØªØµÙ„ Ù…Ù†Ø° ÙØªØ±Ø©</span>',banned:'<span class="status-badge banned-badge">ğŸ”´ Ù…Ø­Ø¸ÙˆØ±</span>'};return n[e]||n.offline}(i),o=e.verificationCodeVerified?'<span class="status-badge verified-badge">âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</span>':'<span class="status-badge not-verified-badge">âŒ ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚</span>',c=e.lastActivity?`Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${K(new Date(e.lastActivity))}`:"Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯",r="leadadmin"!==e.role?`\n                    <button class="action-btn logout-all-btn" onclick="logoutAllDevices('${e._id}', '${e.username}')">\n                        <i class="fas fa-sign-out-alt"></i>\n                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©\n                    </button>\n                    `:"";return`\n                <div class="user-card">\n                    <div class="user-card-header">\n                        <div class="user-avatar-large ${"banned"===i?"banned-avatar":""}">\n                            <i class="fas fa-user-circle"></i>\n                        </div>\n                        <div class="user-main-info">\n                            <h3>${e.firstName} ${e.secondName}</h3>\n                            <div class="user-badges">\n                                <span class="username-badge">@${e.username}</span>\n                                <span class="role-badge ${e.role}">${a}</span>\n                                <span class="grade-badge">${n}</span>\n                                ${l}\n                                ${o}\n                            </div>\n                            <div class="user-status-info">\n                                <small class="last-login-text">${c}</small>\n                            </div>\n                        </div>\n                        <div class="user-points">\n                            <i class="fas fa-star"></i>\n                            <span dir="ltr">${s}</span>\n                        </div>\n                    </div>\n                    \n                    <div class="user-card-details">\n                        <div class="detail-row">\n                            <span class="detail-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${e.email}</span>\n                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠØ¯" onclick="copyText('${e.email.replace(/'/g,"\\'")}')">\n                                <i class="fas fa-copy"></i>\n                              </button>\n                            </span>\n                        </div>\n                        <div class="detail-row">\n                            <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${e.phone}</span>\n                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" onclick="copyText('${e.phone.replace(/'/g,"\\'")}')">\n                                <i class="fas fa-copy"></i>\n                              </button>\n                            </span>\n                        </div>\n                        <div class="detail-row">\n                            <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${new Date(e.createdAt).toLocaleDateString("ar-EG")}</span>\n                            </span>\n                        </div>\n                        <div class="detail-row">\n                            <span class="detail-label">Ø¢Ø®Ø± Ù†Ø´Ø§Ø·:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${e.lastActivity?new Date(e.lastActivity).toLocaleString("ar-EG"):"Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯"}</span>\n                            </span>\n                        </div>\n                        <div class="detail-row">\n                            <span class="detail-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${d=i,{online:"Ù…ØªØµÙ„",idle:"ØºÙŠØ± Ù†Ø´Ø·","signed-in":"Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„","signed-out":"ØºÙŠØ± Ù…ØªØµÙ„",offline:"ØºÙŠØ± Ù…ØªØµÙ„ Ù…Ù†Ø° ÙØªØ±Ø©",banned:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ±"}[d]||"ØºÙŠØ± Ù…ØªØµÙ„"}</span>\n                            </span>\n                        </div>\n                        ${!0===e._isLocal?'\n                        <div class="detail-row" style="background: rgba(52, 152, 219, 0.15); border: 1px solid rgba(52, 152, 219, 0.4); border-radius: 8px; padding: 12px; margin-top: 10px;">\n                            <span class="detail-label" style="color: #3498db; font-weight: 700;">\n                              <i class="fas fa-database"></i> Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠ\n                            </span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value" style="color: #3498db; font-weight: 600; font-size: 14px;">\n                                Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø®Ø²Ù‘ÙÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù…Ù† Ø®Ù„Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\n                              </span>\n                            </span>\n                        </div>\n                        ':""}\n                    </div>\n                    \n                    <div class="user-card-footer">\n                        ${e.verificationCodeVerified?'\n                        <div class="detail-row verified-status-row" style="background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 8px; padding: 12px;">\n                            <span class="detail-label" style="color: #2ecc71; font-weight: 700;">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value" style="color: #2ecc71; font-weight: 700; font-size: 16px;">âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</span>\n                            </span>\n                        </div>\n                        ':e.verificationCode?`\n                        <div class="detail-row verified-status-row" style="background: rgba(255, 204, 0, 0.1); border: 1px solid rgba(255, 204, 0, 0.3); border-radius: 8px; padding: 12px;">\n                            <span class="detail-label" style="color: #ffcc00; font-weight: 700;">ğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value" style="color: #ffcc00; font-weight: 700; font-size: 16px; font-family: monospace;">${e.verificationCode}</span>\n                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚" onclick="copyText('${e.verificationCode.replace(/'/g,"\\'")}')">\n                                <i class="fas fa-copy"></i>\n                              </button>\n                            </span>\n                        </div>\n                        `:""}\n                    <div class="user-card-actions">\n                        <button class="action-btn points-btn" onclick="givePoints('${e._id}', '${e.username}')">\n                            <i class="fas fa-plus-circle"></i>\n                            Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·\n                        </button>\n                        <button class="action-btn remove-points-btn" onclick="openTakePointsModal('${e._id}', '${e.username}')">\n                            <i class="fas fa-minus-circle"></i>\n                            Ø®ØµÙ… Ù†Ù‚Ø§Ø·\n                        </button>\n                        <button class="action-btn edit-btn" onclick="openEditUserModal('${e._id}')">\n                            <i class="fas fa-edit"></i>\n                            ØªØ¹Ø¯ÙŠÙ„\n                        </button>\n                        <button class="action-btn reset-link-btn" onclick="generatePasswordResetLink('${e._id}', '${(e.username||"").replace(/'/g,"\\'")}')" title="Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (7 Ø£ÙŠØ§Ù…)">\n                            <i class="fas fa-key"></i>\n                            Ø±Ø§Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±\n                        </button>\n                        <button class="action-btn reset-links-view-btn" onclick="showPasswordResetLinks('${e._id}', '${(e.username||"").replace(/'/g,"\\'")}')" title="Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©">\n                            <i class="fas fa-link"></i>\n                            Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø·\n                        </button>\n                        <button class="action-btn ban-btn" onclick="openBanModal('${e._id}', '${e.username}')">\n                            <i class="fas fa-ban"></i>\n                            Ø­Ø¸Ø±\n                        </button>\n                        <button class="action-btn delete-btn" onclick="deleteUser('${e._id}', '${e.username}')">\n                            <i class="fas fa-trash"></i>\n                            Ø­Ø°Ù\n                        </button>\n                        ${r}\n                    </div>\n                    </div>\n                </div>\n            `;var d}).join("")}function G(e){const n={online:0,idle:1,"signed-in":2,"signed-out":3,offline:4,banned:5},t=[...e||[]].sort((e,t)=>{const s=Z(e),a=Z(t),i=n[s]??99,l=n[a]??99;if(i!==l)return i-l;const o=e.lastActivity?new Date(e.lastActivity).getTime():0,c=t.lastActivity?new Date(t.lastActivity).getTime():0;return c!==o?c-o:(e.username||"").localeCompare(t.username||"")});a.innerHTML=_(t),j()}function O(){f.classList.remove("active")}function R(){p&&p.classList.remove("active")}function F(){m.classList.remove("active")}async function W(){try{const e=await fetch("/api/banned-users");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();if(!Array.isArray(n))throw new Error("Invalid response format from server");if(A=n,!n||0===n.length)return void(i.innerHTML='\n              <div class="empty-state">\n                  <i class="fas fa-user-check"></i>\n                  <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</h3>\n                  <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>\n              </div>\n          ');!function(e){if(!Array.isArray(e))return void(i.innerHTML='\n          <div class="empty-state">\n              <i class="fas fa-exclamation-circle"></i>\n              <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>\n              <p>Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>\n          </div>\n      ');const n=[...e].sort((e,n)=>{const t=e.createdAt?new Date(e.createdAt).getTime():0;return(n.createdAt?new Date(n.createdAt).getTime():0)-t});i.innerHTML=n.map(e=>{const n={login:"Ø­Ø¸Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",forms:"Ø­Ø¸Ø± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬",all:"Ø­Ø¸Ø± ÙƒØ§Ù…Ù„"}[e.banType]||e.banType,t={login:'<span class="status-badge" style="background: #f39c12; color: white;">ğŸ” Ø­Ø¸Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>',forms:'<span class="status-badge" style="background: #e67e22; color: white;">ğŸ“ Ø­Ø¸Ø± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</span>',all:'<span class="status-badge" style="background: #e74c3c; color: white;">ğŸš« Ø­Ø¸Ø± ÙƒØ§Ù…Ù„</span>'}[e.banType]||'<span class="status-badge banned-badge">ğŸ”´ Ù…Ø­Ø¸ÙˆØ±</span>',s=e.createdAt?new Date(e.createdAt).toLocaleString("ar-EG"):"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",a=e.createdAt?K(new Date(e.createdAt)):"";return`\n                <div class="user-card">\n                    <div class="user-card-header">\n                        <div class="user-avatar-large banned-avatar">\n                            <i class="fas fa-user-slash"></i>\n                        </div>\n                        <div class="user-main-info">\n                            <h3>@${e.username}</h3>\n                            <div class="user-badges">\n                                ${t}\n                            </div>\n                            <div class="user-status-info">\n                                <small class="last-login-text">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¸Ø±: ${a||s}</small>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class="user-card-details">\n                        <div class="detail-row">\n                            <span class="detail-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">@${e.username}</span>\n                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" onclick="copyText('${e.username.replace(/'/g,"\\'")}')">\n                                <i class="fas fa-copy"></i>\n                              </button>\n                            </span>\n                        </div>\n                        <div class="detail-row">\n                            <span class="detail-label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¸Ø±:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${n}</span>\n                            </span>\n                        </div>\n                        ${e.reason?`\n                        <div class="detail-row">\n                            <span class="detail-label">Ø§Ù„Ø³Ø¨Ø¨:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${e.reason}</span>\n                            </span>\n                        </div>\n                        `:""}\n                        <div class="detail-row">\n                            <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¸Ø±:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${s}</span>\n                            </span>\n                        </div>\n                        ${e.expiresAt?`\n                        <div class="detail-row">\n                            <span class="detail-label">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">${new Date(e.expiresAt).toLocaleString("ar-EG")}</span>\n                            </span>\n                        </div>\n                        `:'\n                        <div class="detail-row">\n                            <span class="detail-label">Ø§Ù„Ù…Ø¯Ø©:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">Ø¯Ø§Ø¦Ù…</span>\n                            </span>\n                        </div>\n                        '}\n                        ${e.createdBy?`\n                        <div class="detail-row">\n                            <span class="detail-label">Ø­Ø¸Ø± Ø¨ÙˆØ§Ø³Ø·Ø©:</span>\n                            <span class="detail-value-wrap">\n                              <span class="detail-value">@${e.createdBy}</span>\n                            </span>\n                        </div>\n                        `:""}\n                    </div>\n                    \n                    <div class="user-card-actions">\n                        <button class="action-btn unban-btn" onclick="unbanUser('${e.username.replace(/'/g,"\\'")}')" style="background: #27ae60; color: white;">\n                            <i class="fas fa-unlock"></i>\n                            Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±\n                        </button>\n                    </div>\n                </div>\n            `}).join("")}(n)}catch(e){i.innerHTML='\n          <div class="empty-state">\n              <i class="fas fa-exclamation-circle"></i>\n              <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>\n              <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>\n          </div>\n      '}}async function z(){if((await Swal.fire({title:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",text:"Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ",icon:"question",iconColor:"#ffcc00",showCancelButton:!0,confirmButtonText:"Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",cancelButtonText:"Ø¥Ù„ØºØ§Ø¡",confirmButtonColor:"#e74c3c",cancelButtonColor:"#666",background:"#2a1b3c",color:"#fff",backdrop:"rgba(0,0,0,0.8)",allowOutsideClick:!1})).isConfirmed)try{(await fetch("/logout",{method:"POST"})).ok&&(await Swal.fire({title:"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",text:"ÙˆØ¯Ø§Ø¹Ø§Ù‹! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø¨Ù†Ø¬Ø§Ø­",icon:"success",iconColor:"#27ae60",background:"#2a1b3c",color:"#fff",backdrop:"rgba(0,0,0,0.8)",showConfirmButton:!1,timer:1500}),setTimeout(()=>{window.location.href="/"},500))}catch(e){window.location.href="/"}}v.addEventListener("submit",async function(e){e.preventDefault();const n=document.getElementById("editUserId").value,t=document.getElementById("editFirstName").value,s=document.getElementById("editSecondName").value,a=document.getElementById("editEmail").value,i=document.getElementById("editPhone").value,l=document.getElementById("editGrade").value,o=document.getElementById("editPassword").value,c=document.getElementById("editSubmitBtn"),r=document.getElementById("editBtnText"),d=document.getElementById("editBtnLoading");c.disabled=!0,r.style.display="none",d.style.display="inline";try{const e={firstName:t,secondName:s,email:a,phone:i,grade:l};if(o){if(o.length<8)throw new Error("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");if(!/[A-Z]/.test(o))throw new Error("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØ§Ø­Ø¯");if(!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(o))throw new Error("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø² ÙˆØ§Ø­Ø¯ (!@#$%...)");e.password=o}const c=await fetch(`/api/admin/users/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(c.ok)O(),Swal.fire({title:"ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",text:"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",icon:"success",confirmButtonText:"Ø­Ø³Ù†Ø§Ù‹",confirmButtonColor:"#ffcc00"}),N();else{const e=(await c.json().catch(()=>({}))).message||"ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";if(!e.includes("contact carl")&&!e.includes("ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙƒØ§Ø±Ù„"))throw new Error(e);Swal.fire({title:"ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­!",text:"ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙƒØ§Ø±Ù„ Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",icon:"warning",confirmButtonText:"Ø­Ø³Ù†Ø§Ù‹",confirmButtonColor:"#ffcc00"})}}catch(u){Swal.fire({title:"Ø®Ø·Ø£!",text:u.message||"ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",icon:"error",confirmButtonText:"Ø­Ø³Ù†Ø§Ù‹"})}finally{c.disabled=!1,r.style.display="inline",d.style.display="none"}}),w.addEventListener("click",O),E.addEventListener("click",O),document.getElementById("banDurationTemporary").addEventListener("change",function(){document.getElementById("banDaysWrap").style.display=this.checked?"block":"none"}),document.getElementById("banDurationPermanent").addEventListener("change",function(){document.getElementById("banDaysWrap").style.display="none"}),g.addEventListener("submit",async function(e){e.preventDefault();const n=document.getElementById("banUserId").value,t=document.getElementById("banType").value,s=document.getElementById("banReason").value,a=document.getElementById("banSubmitBtn"),i=document.getElementById("banBtnText"),l=document.getElementById("banBtnLoading");if(!t)return void Swal.fire({title:"Ø®Ø·Ø£!",text:"ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¸Ø±",icon:"error",confirmButtonText:"Ø­Ø³Ù†Ø§Ù‹"});const o=document.querySelector('input[name="banDuration"]:checked')?.value||"permanent",c=document.getElementById("banDays"),r="temporary"===o&&c?c.value:null;if("temporary"!==o||r&&!(parseInt(r,10)<1)){a.disabled=!0,i.style.display="none",l.style.display="inline";try{const e=await fetch(`/api/admin/users/${n}`);if(!e.ok)throw 403===e.status?new Error("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"):404===e.status?new Error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"):new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (${e.status})`);const a=await e.json();if(!a||!a.username)throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­Ø©");const i=await fetch("/api/banned-users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a.username,banType:t,reason:s,duration:o,days:"temporary"===o?parseInt(c.value,10):null})});if(!i.ok){const e=await i.json().catch(()=>({}));throw new Error(e.message||"ÙØ´Ù„ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")}F(),Swal.fire({title:"ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",text:"ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",icon:"success",confirmButtonText:"Ø­Ø³Ù†Ø§Ù‹",confirmButtonColor:"#ffcc00"}),N(),W()}catch(d){Swal.fire({title:"Ø®Ø·Ø£!",text:d.message||"ØªØ¹Ø°Ø± Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",icon:"error",confirmButtonText:"Ø­Ø³Ù†Ø§Ù‹"})}finally{a.disabled=!1,i.style.display="inline",l.style.display="none"}}else Swal.fire({title:"Ø®Ø·Ø£!",text:"ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (1 Ø£Ùˆ Ø£ÙƒØ«Ø±)",icon:"error",confirmButtonText:"Ø­Ø³Ù†Ø§Ù‹"})}),L.addEventListener("click",F),B.addEventListener("click",F),t.addEventListener("click",z),s.addEventListener("click",z),l.addEventListener("click",function(){"none"===u.style.display?(d.style.display="none",u.style.display="block",l.innerHTML='<i class="fas fa-users"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†',W()):(d.style.display="block",u.style.display="none",l.innerHTML='<i class="fas fa-ban"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†',U(S))}),o.addEventListener("click",()=>{N(),"none"!==u.style.display&&W()}),c.addEventListener("input",function(){const e=c.value.toLowerCase().trim();if(r.style.display=e?"flex":"none",!e)return void U(S);const n=x.filter(n=>n.firstName.toLowerCase().includes(e)||n.secondName.toLowerCase().includes(e)||n.username.toLowerCase().includes(e)||n.email.toLowerCase().includes(e)||n.phone.includes(e));0===n.length?a.innerHTML='\n          <div class="empty-state">\n              <i class="fas fa-search"></i>\n              <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>\n              <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ø¨Ø­Ø«Ùƒ</p>\n          </div>\n      ':G(n)}),r.addEventListener("click",()=>{c.value="",r.style.display="none",U(S)}),y.forEach(e=>{e.addEventListener("click",()=>{y.forEach(e=>e.classList.remove("active")),e.classList.add("active"),S=e.dataset.category,N(!0)})}),document.addEventListener("click",function(t){if(window.innerWidth<=992&&n&&e&&!n.contains(t.target)&&!e.contains(t.target)){n.classList.remove("active");const t=e.querySelectorAll("span");t[0].style.transform="none",t[1].style.opacity="1",t[2].style.transform="none"}}),document.addEventListener("DOMContentLoaded",function(){!async function(){try{const e=await fetch("/api/user-info"),n=await e.json();if(!n.isAuthenticated)return void(window.location.href="/login");M=n.username,document.getElementById("username").textContent=n.username;const t=document.getElementById("userRole");t.textContent="leadadmin"===n.role?"Ù„ÙŠØ¯ Ø£Ø¯Ù…Ù†":"admin"===n.role?"Ù…Ø´Ø±Ù":n.role,t.className="role-badge role-"+(n.role||"admin"),document.querySelectorAll("[data-nav-access]").forEach(function(e){var t=e.getAttribute("data-nav-access");e.style.display=n[t]?"":"none"})}catch(e){}}(),N()}),b&&b.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault();const n=!h.classList.contains("open");document.querySelectorAll(".grades-submenu.open, .suggestions-submenu.open").forEach(e=>{e!==h&&e.classList.remove("open")}),n||(document.querySelectorAll(".section-submenu.open").forEach(e=>{e.classList.remove("open")}),document.querySelectorAll(".section-toggle.open").forEach(e=>{e.classList.remove("open")})),h.classList.toggle("open"),b.classList.toggle("open");const t=document.getElementById("suggestionsToggle"),s=document.getElementById("suggestionsSubmenu");t&&s&&s.classList.contains("open")&&(s.classList.remove("open"),t.classList.remove("open"))});const V=document.getElementById("suggestionsToggle"),J=document.getElementById("suggestionsSubmenu");function Z(e){if(function(e){return A.some(n=>n.username===e.username)}(e))return"banned";const n=e?.lastActivity?new Date(e.lastActivity):null;if(!n||Number.isNaN(n.getTime()))return"offline";const t=Date.now()-n.getTime(),s=Math.floor(t/6e4);return t/864e5>7?"offline":s<=2?"online":s<=30?"idle":"signed-in"}function K(e){const n=new Date-e,t=Math.floor(n/6e4),s=Math.floor(t/60),a=Math.floor(s/24);return t<1?"Ø§Ù„Ø¢Ù†":t<60?`Ù…Ù†Ø° ${t} Ø¯Ù‚ÙŠÙ‚Ø©`:s<24?`Ù…Ù†Ø° ${s} Ø³Ø§Ø¹Ø©`:a<7?`Ù…Ù†Ø° ${a} ÙŠÙˆÙ…`:e.toLocaleDateString("ar-EG")}V&&J&&(J.classList.remove("open"),V.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault();const n=!J.classList.contains("open");document.querySelectorAll(".grades-submenu.open, .suggestions-submenu.open").forEach(e=>{e!==J&&e.classList.remove("open")}),n&&h&&h.classList.contains("open")&&(h.classList.remove("open"),b&&b.classList.remove("open")),J.classList.toggle("open"),V.classList.toggle("open")})),document.querySelectorAll(".section-toggle").forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault();const n=this.dataset.section,t=document.querySelector(`.section-submenu[data-section="${n}"]`);t&&(document.querySelectorAll(".section-submenu.open").forEach(e=>{e!==t&&e.classList.remove("open")}),document.querySelectorAll(".section-toggle.open").forEach(e=>{e!==this&&e.classList.remove("open")}),t.classList.toggle("open"),this.classList.toggle("open"))})}),document.addEventListener("click",function(t){if(window.innerWidth<=992&&n&&e&&!t.target.closest(".sidebar")&&!t.target.closest(".mobile-toggle")&&!e.contains(t.target)&&(document.querySelectorAll(".grades-submenu.open, .suggestions-submenu.open, .section-submenu.open").forEach(e=>{e.classList.remove("open")}),document.querySelectorAll(".grades-toggle.open, .suggestions-toggle.open, .section-toggle.open").forEach(e=>{e.classList.remove("open")}),n.classList.contains("active"))){n.classList.remove("active");const t=e.querySelectorAll("span");t[0].style.transform="none",t[1].style.opacity="1",t[2].style.transform="none"}}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".grades-submenu, .suggestions-submenu, .section-submenu").forEach(e=>{e.classList.remove("open")}),document.querySelectorAll(".grades-toggle, .suggestions-toggle, .section-toggle").forEach(e=>{e.classList.remove("open")})}),document.addEventListener("keydown",function(e){"Escape"===e.key&&(O(),R(),F())}),window.addEventListener("click",function(e){e.target===f&&O(),e.target===p&&R(),e.target===m&&F()}),I&&I.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),k.classList.toggle("active"),k.classList.contains("active")&&($.style.animation="fadeInUp 0.3s ease")}),T.forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.category;T.forEach(e=>e.classList.remove("active")),this.classList.add("active"),S=e,N(!0);const n=this.textContent.replace(this.querySelector(".category-count").textContent,"").trim();I.innerHTML=`\n      <i class="fas fa-filter"></i>\n      ${n}\n      <i class="fas fa-chevron-down"></i>\n  `,k.classList.remove("active")})}),document.addEventListener("click",function(e){k&&!k.contains(e.target)&&k.classList.remove("active")}),document.addEventListener("keydown",function(e){"Escape"===e.key&&k&&k.classList.remove("active")});