(e => { let t = !1; const n = () => { t || (t = !0, e()) }; "loading" === document.readyState ? (document.addEventListener("DOMContentLoaded", n, { once: !0 }), window.addEventListener("load", n, { once: !0 }), window.addEventListener("pageshow", n, { once: !0 })) : ("function" == typeof queueMicrotask ? queueMicrotask : e => Promise.resolve().then(e))(n) })(() => { const e = document.getElementById("create-form"), t = document.getElementById("form-modal"), n = t ? t.querySelector(".close-button") : null, i = document.getElementById("form-creator"), a = document.getElementById("questions-container"), o = document.getElementById("add-question"), s = document.getElementById("forms-list"), l = document.getElementById("target-grade"), r = document.getElementById("status"), c = document.getElementById("allow-retake"), u = document.getElementById("logoutBtn"), d = document.getElementById("logoutBtnMobile"), p = document.getElementById("user-role-pill"), m = document.getElementById("username-display"), y = document.getElementById("user-menu-name"), v = document.getElementById("user-menu-role"), f = document.getElementById("user-menu"), b = "form_modal_data"; function h() { if (!i) return; const e = { topic: document.getElementById("topic")?.value || "", description: document.getElementById("description")?.value || "", expiry: document.getElementById("expiry")?.value || "", targetGrade: l?.value || "all", status: r?.value || "draft", allowRetake: c?.checked || !1, questions: Array.from(document.querySelectorAll(".question")).map(e => ({ questionText: e.querySelector(".question-text")?.value || "", questionType: e.querySelector(".question-type")?.value || "", options: Array.from(e.querySelectorAll(".option")).map(e => e.value), correctAnswer: e.querySelector(".correct-answer")?.value || "", points: parseInt(e.querySelector(".question-points")?.value || "10"), hasPoints: !1 !== e.querySelector(".question-has-points")?.checked })).filter(e => e.questionText && e.questionType) }; localStorage.setItem(b, JSON.stringify(e)) } function g() { t && (t.style.display = "none", t.classList.remove("active"), document.body.style.overflow = "auto") } e && e.addEventListener("click", () => { t && (t.style.display = "block", t.classList.add("active"), document.body.style.overflow = "hidden", function () { try { const e = localStorage.getItem(b); if (!e) return !1; const t = JSON.parse(e); return document.getElementById("topic") && (document.getElementById("topic").value = t.topic || ""), document.getElementById("description") && (document.getElementById("description").value = t.description || ""), document.getElementById("expiry") && (document.getElementById("expiry").value = t.expiry || ""), l && (l.value = t.targetGrade || "all"), r && (r.value = t.status || "draft"), c && (c.checked = t.allowRetake || !1), t.questions && t.questions.length > 0 && a && (a.innerHTML = "", t.questions.forEach((e, t) => { const n = document.createElement("div"); n.className = "question", n.innerHTML = `\n                        <label>نوع السؤال:</label>\n                        <select class="question-type">\n                            <option value="" disabled>اختر خياراً</option>\n                            <option value="true-false" ${"true-false" === e.questionType ? "selected" : ""}>صحيح/خطأ</option>\n                            <option value="multiple-choice" ${"multiple-choice" === e.questionType ? "selected" : ""}>اختيارات متعددة</option>\n                        </select>\n                        <div class="question-fields"></div>\n                        <button type="button" class="remove-question">❌</button>\n                    `; const i = n.querySelector(".question-type"), o = n.querySelector(".question-fields"); if ("true-false" === e.questionType) { o.innerHTML = `\n                            <label>نص السؤال:</label>\n                            <input type="text" class="question-text" value="${e.questionText}" required>\n                            <label style="display: flex; align-items: center; gap: 8px;">\n                                <input type="checkbox" class="question-has-points" ${e.hasPoints ? "checked" : ""}>\n                                <span>هذا السؤال مع نقاط</span>\n                            </label>\n                            <div class="points-container" style="display: ${e.hasPoints ? "block" : "none"}">\n                                <label>النقاط (افتراضي: 10):</label>\n                                <input type="number" class="question-points" value="${e.points || 10}">\n                            </div>\n                            <label>الإجابة الصحيحة:</label>\n                            <select class="correct-answer">\n                                <option value="True" ${"True" === e.correctAnswer ? "selected" : ""}>صحيح</option>\n                                <option value="False" ${"False" === e.correctAnswer ? "selected" : ""}>خطأ</option>\n                            </select>\n                        `; const t = o.querySelector(".question-has-points"), n = o.querySelector(".points-container"), i = o.querySelector(".question-points"); t && n && i && (t.addEventListener("change", e => { e.target.checked ? (n.style.display = "block", i.required = !0, i.setAttribute("min", "1"), i.value = i.value || "10") : (n.style.display = "none", i.removeAttribute("required"), i.removeAttribute("min"), i.value = "0") }), e.hasPoints && (i.required = !0, i.setAttribute("min", "1"))) } else { o.innerHTML = `\n                            <label>نص السؤال:</label>\n                            <input type="text" class="question-text" value="${e.questionText}" required>\n                            <label style="display: flex; align-items: center; gap: 8px;">\n                                <input type="checkbox" class="question-has-points" ${e.hasPoints ? "checked" : ""}>\n                                <span>هذا السؤال مع نقاط</span>\n                            </label>\n                            <div class="points-container" style="display: ${e.hasPoints ? "block" : "none"}">\n                                <label>النقاط (افتراضي: 10):</label>\n                                <input type="number" class="question-points" value="${e.points || 10}">\n                            </div>\n                            <div class="options">\n                                <label>الخيار 1:</label><input type="text" class="option" value="${e.options[0] || ""}" required>\n                                <label>الخيار 2:</label><input type="text" class="option" value="${e.options[1] || ""}" required>\n                                <label>الخيار 3:</label><input type="text" class="option" value="${e.options[2] || ""}" required>\n                                <label>الخيار 4:</label><input type="text" class="option" value="${e.options[3] || ""}" required>\n                            </div>\n                            <label>الإجابة الصحيحة:</label>\n                            <select class="correct-answer">\n                                <option value="1" ${"1" === e.correctAnswer ? "selected" : ""}>الخيار 1</option>\n                                <option value="2" ${"2" === e.correctAnswer ? "selected" : ""}>الخيار 2</option>\n                                <option value="3" ${"3" === e.correctAnswer ? "selected" : ""}>الخيار 3</option>\n                                <option value="4" ${"4" === e.correctAnswer ? "selected" : ""}>الخيار 4</option>\n                            </select>\n                        `; const t = o.querySelector(".question-has-points"), n = o.querySelector(".points-container"), i = o.querySelector(".question-points"); t && n && i && (t.addEventListener("change", e => { e.target.checked ? (n.style.display = "block", i.required = !0, i.setAttribute("min", "1"), i.value = i.value || "10") : (n.style.display = "none", i.removeAttribute("required"), i.removeAttribute("min"), i.value = "0") }), e.hasPoints && (i.required = !0, i.setAttribute("min", "1"))) } i.addEventListener("change", e => { const t = n.querySelector(".question-fields"); if (t.innerHTML = "", "true-false" === e.target.value) { t.innerHTML = '\n                                <label>نص السؤال:</label>\n                                <input type="text" class="question-text" required>\n                                <label style="display: flex; align-items: center; gap: 8px;">\n                                    <input type="checkbox" class="question-has-points" checked>\n                                    <span>هذا السؤال مع نقاط</span>\n                                </label>\n                                <div class="points-container">\n                                    <label>النقاط (افتراضي: 10):</label>\n                                    <input type="number" class="question-points" value="10" required>\n                                </div>\n                                <label>الإجابة الصحيحة:</label>\n                                <select class="correct-answer">\n                                    <option value="True">صحيح</option>\n                                    <option value="False">خطأ</option>\n                                </select>\n                            '; const e = t.querySelector(".question-has-points"), n = t.querySelector(".points-container"), i = t.querySelector(".question-points"); e && n && i && (i.setAttribute("min", "1"), e.addEventListener("change", e => { e.target.checked ? (n.style.display = "block", i.required = !0, i.setAttribute("min", "1"), i.value = i.value || "10") : (n.style.display = "none", i.removeAttribute("required"), i.removeAttribute("min"), i.value = "0") })) } else if ("multiple-choice" === e.target.value) { t.innerHTML = '\n                                <label>نص السؤال:</label>\n                                <input type="text" class="question-text" required>\n                                <label style="display: flex; align-items: center; gap: 8px;">\n                                    <input type="checkbox" class="question-has-points" checked>\n                                    <span>هذا السؤال مع نقاط</span>\n                                </label>\n                                <div class="points-container">\n                                    <label>النقاط (افتراضي: 10):</label>\n                                    <input type="number" class="question-points" value="10" required>\n                                </div>\n                                <div class="options">\n                                    <label>الخيار 1:</label><input type="text" class="option" required>\n                                    <label>الخيار 2:</label><input type="text" class="option" required>\n                                    <label>الخيار 3:</label><input type="text" class="option" required>\n                                    <label>الخيار 4:</label><input type="text" class="option" required>\n                                </div>\n                                <label>الإجابة الصحيحة:</label>\n                                <select class="correct-answer">\n                                    <option value="1">الخيار 1</option>\n                                    <option value="2">الخيار 2</option>\n                                    <option value="3">الخيار 3</option>\n                                    <option value="4">الخيار 4</option>\n                                </select>\n                            '; const e = t.querySelector(".question-has-points"), n = t.querySelector(".points-container"), i = t.querySelector(".question-points"); e && n && i && (i.setAttribute("min", "1"), e.addEventListener("change", e => { e.target.checked ? (n.style.display = "block", i.required = !0, i.setAttribute("min", "1"), i.value = i.value || "10") : (n.style.display = "none", i.removeAttribute("required"), i.removeAttribute("min"), i.value = "0") })) } }), n.querySelector(".remove-question").addEventListener("click", () => { a.removeChild(n), h() }), a.appendChild(n) })), !0 } catch (e) { return !1 } }()) }), i && (i.addEventListener("input", h), i.addEventListener("change", h)), window.addEventListener("beforeunload", h), document.addEventListener("keydown", e => { "Escape" === e.key && t && "block" === t.style.display && g() }), n && n.addEventListener("click", g); const q = t ? t.querySelector(".cancel-btn") : null; async function w() { if (s) { s.innerHTML = '\n            <div class="loading-state">\n                <span class="loading-dots" aria-hidden="true"><span></span><span></span><span></span></span>\n                <p>جاري التحميل...</p>\n            </div>\n        '; try { const e = await fetch("/api/forms", { method: "GET", credentials: "include", headers: { "Content-Type": "application/json" } }); if (!e.ok) { const t = await e.json().catch(() => ({ message: "فشل تحميل النماذج" })); throw new Error(t.message || `HTTP ${e.status}: فشل تحميل النماذج`) } const t = await e.json(), n = Array.isArray(t) ? t : t.active || [], i = t.expired || [], a = document.getElementById("dashboard-stats"); if (a) { const e = n.length + i.length; a.innerHTML = `\n          <div class="stat-card stat-success">\n            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>\n            <div class="stat-value">${n.length}</div>\n            <div class="stat-label">نشطة</div>\n          </div>\n          <div class="stat-card stat-warning">\n            <div class="stat-icon"><i class="fas fa-clock"></i></div>\n            <div class="stat-value">${i.length}</div>\n            <div class="stat-label">منتهية</div>\n          </div>\n          <div class="stat-card stat-info">\n            <div class="stat-icon"><i class="fas fa-layer-group"></i></div>\n            <div class="stat-value">${e}</div>\n            <div class="stat-label">الإجمالي</div>\n          </div>\n        ` } if (s.innerHTML = "", 0 === n.length && 0 === i.length) { const e = document.createElement("div"); e.className = "empty-state", e.style.cssText = "grid-column: 1 / -1; text-align: center; padding: 50px 20px; width: 100%;", e.innerHTML = '\n                    <i class="fas fa-file-alt"></i>\n                    <h3>لا توجد نماذج</h3>\n                    <p>لم يتم إنشاء أي نموذج حتى الآن.</p>\n                ', s.appendChild(e) } else { if (n.length > 0) { const e = document.createElement("h2"); e.className = "section-title", e.innerHTML = `\n                        <i class="fas fa-check-circle"></i>\n                        النماذج النشطة (${n.length})\n                    `, s.appendChild(e); const t = document.createElement("div"); t.className = "forms-section", s.appendChild(t), n.forEach(e => { x(e, t, !1) }) } if (i.length > 0) { const e = document.createElement("h2"); e.className = "section-title", e.innerHTML = `\n                        <i class="fas fa-clock"></i>\n                        النماذج المنتهية (${i.length})\n                    `, s.appendChild(e); const t = document.createElement("div"); t.className = "forms-section", s.appendChild(t), i.forEach(e => { x(e, t, !0) }) } } } catch (e) { const t = document.createElement("div"); t.className = "empty-state", t.style.cssText = "grid-column: 1 / -1; text-align: left; padding: 50px 20px; width: 100%; display: flex; flex-direction: column; align-items: flex-start; gap: 15px;", t.innerHTML = `\n                <i class="fas fa-exclamation-circle"></i>\n                <h3>حدث خطأ</h3>\n                <p>${e.message || "تعذر تحميل النماذج. يرجى المحاولة مرة أخرى."}</p>\n                <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: var(--accent); color: var(--dark); border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">\n                    إعادة المحاولة\n                </button>\n            `, s.innerHTML = "", s.appendChild(t), window.innerWidth <= 768 && (t.style.textAlign = "center", t.style.alignItems = "center") } } } function x(e, t, n) { const i = e.expiry ? new Date(e.expiry) : null, a = e.link && String(e.link).trim() ? String(e.link).trim() : e._id ? String(e._id) : "", o = document.createElement("div"); o.className = n ? "form-card expired" : "form-card"; const s = !n && "published" === e.status; o.innerHTML = `\n            <div class="form-header">\n                <div class="form-icon">\n                    <i class="fas fa-file-alt"></i>\n                </div>\n                <span class="form-status ${n ? "status-expired" : "published" === e.status ? "status-published" : "status-draft"}">\n                    ${n ? "منتهي" : "published" === e.status ? "منشور" : "مسودة"}\n                </span>\n            </div>\n            <h3 class="form-title">${e.topic}</h3>\n            <p class="form-description">${e.description || "لا يوجد وصف"}</p>\n            <div class="form-meta">\n                <div class="meta-item">\n                    <span class="meta-label">الفئة:</span>\n                    <span class="meta-value">${e.targetGrade || "all"}</span>\n                </div>\n                <div class="meta-item">\n                    <span class="meta-label">الأسئلة:</span>\n                    <span class="meta-value">${e.questions?.length || 0}</span>\n                </div>\n                <div class="meta-item">\n                    <span class="meta-label">ينتهي:</span>\n                    <span class="meta-value">${i ? i.toLocaleDateString("ar-EG") : "بدون موعد"}</span>\n                </div>\n            </div>\n            <div class="form-actions">\n                <a href="/form/${a}/leaderboard" target="_blank" class="action-btn view-btn">\n                    <i class="fas fa-trophy"></i>\n                    لوحة الترتيب\n                </a>\n                <a href="/form/${a}" target="_blank" class="action-btn view-btn">\n                    <i class="fas fa-eye"></i>\n                    عرض النموذج\n                </a>\n                <button class="action-btn copy-btn" data-form-ident="${a}">\n                    <i class="fas fa-copy"></i>\n                    نسخ\n                </button>\n                ${s ? `\n                <button class="action-btn deactivate-btn" data-form-ident="${a}">\n                    <i class="fas fa-eye-slash"></i>\n                    تعطيل\n                </button>\n                ` : ""}\n                ${n ? `\n                <button class="action-btn reactivate-btn" data-form-ident="${a}">\n                    <i class="fas fa-redo"></i>\n                    إعادة تفعيل\n                </button>\n                ` : ""}\n                <button class="action-btn delete-btn" data-form-id="${e._id || ""}" data-form-ident="${a}">\n                    <i class="fas fa-trash"></i>\n                    حذف\n                </button>\n            </div>\n        `, t.appendChild(o); const l = o.querySelector(".copy-btn"); l && l.addEventListener("click", () => { window.copyFormLink(a) }); const r = o.querySelector(".deactivate-btn"); r && r.addEventListener("click", () => { window.deactivateForm(a, r) }); const c = o.querySelector(".reactivate-btn"); c && c.addEventListener("click", () => { window.reactivateForm(a, c) }); const u = o.querySelector(".delete-btn"); u && u.addEventListener("click", () => { !async function (e, t, n) { if ((await Swal.fire({ title: "هل أنت متأكد؟", text: "هل أنت متأكد أنك تريد حذف هذا النموذج نهائيًا؟ سيتم حذف جميع البيانات المرتبطة به ولا يمكن استرجاعها لاحقًا.", icon: "warning", showCancelButton: !0, confirmButtonText: "نعم، احذف نهائيًا", cancelButtonText: "إلغاء", confirmButtonColor: "#e74c3c", cancelButtonColor: "#666" })).isConfirmed) try { n && (n.disabled = !0, n.innerHTML = '<span class="loading-dots" aria-hidden="true"><span></span><span></span><span></span></span><span style="margin-right:8px">جاري الحذف...</span>'); const e = await fetch(`/api/forms/${t}`, { method: "DELETE", headers: { "Content-Type": "application/json" } }), i = await e.json(); if (!e.ok) throw new Error(i.message || "حدث خطأ أثناء حذف النموذج"); Swal.fire({ title: "تم الحذف", text: i.message || "تم حذف النموذج نهائيًا بنجاح.", icon: "success", confirmButtonText: "حسنًا", confirmButtonColor: "#ffcc00" }), w() } catch (i) { Swal.fire({ title: "خطأ", text: i.message || "حدث خطأ أثناء محاولة حذف النموذج. يرجى المحاولة مرة أخرى لاحقًا.", icon: "error", confirmButtonText: "حسنًا" }) } finally { n && (n.disabled = !1, n.innerHTML = '<i class="fas fa-trash"></i> حذف') } }(e._id, a, u) }) } async function E() { if ((await Swal.fire({ title: "تسجيل الخروج", text: "هل تريد فعلاً تسجيل الخروج من النظام؟", icon: "question", iconColor: "#ffcc00", showCancelButton: !0, confirmButtonText: "نعم، تسجيل خروج", cancelButtonText: "إلغاء", confirmButtonColor: "#e74c3c", cancelButtonColor: "#666", background: "#2a1b3c", color: "#fff", backdrop: "rgba(0,0,0,0.8)", allowOutsideClick: !1 })).isConfirmed) try { (await fetch("/logout", { method: "POST" })).ok && (await Swal.fire({ title: "تم تسجيل الخروج", text: "وداعاً! تم تسجيل خروجك بنجاح", icon: "success", iconColor: "#27ae60", background: "#2a1b3c", color: "#fff", backdrop: "rgba(0,0,0,0.8)", showConfirmButton: !1, timer: 1500 }), setTimeout(() => { window.location.href = "/" }, 500)) } catch (e) { window.location.href = "/" } } q && q.addEventListener("click", g), t && t.addEventListener("click", e => { e.target === t && g() }), o && o.addEventListener("click", () => { if (!a) return; const e = document.createElement("div"); e.className = "question", e.innerHTML = '\n                <label>نوع السؤال:</label>\n                <select class="question-type">\n                    <option value="" disabled selected>اختر خياراً</option>\n                    <option value="true-false">صحيح/خطأ</option>\n                    <option value="multiple-choice">اختيارات متعددة</option>\n                </select>\n                <div class="question-fields"></div>\n                <button type="button" class="remove-question">❌</button>\n            ', e.querySelector(".question-type").addEventListener("change", t => { const n = e.querySelector(".question-fields"); if (n.innerHTML = "", "true-false" === t.target.value) { n.innerHTML = '\n                        <label>نص السؤال:</label>\n                        <input type="text" class="question-text" required>\n                        <label style="display: flex; align-items: center; gap: 8px;">\n                            <input type="checkbox" class="question-has-points" checked>\n                            <span>هذا السؤال مع نقاط</span>\n                        </label>\n                        <div class="points-container">\n                            <label>النقاط (افتراضي: 10):</label>\n                            <input type="number" class="question-points" value="10" required>\n                        </div>\n                        <label>الإجابة الصحيحة:</label>\n                        <select class="correct-answer">\n                            <option value="True">صحيح</option>\n                            <option value="False">خطأ</option>\n                        </select>\n                    '; const e = n.querySelector(".question-has-points"), t = n.querySelector(".points-container"), i = t.querySelector(".question-points"); e.addEventListener("change", e => { e.target.checked ? (t.style.display = "block", i.required = !0, i.setAttribute("min", "1"), i.value = i.value || "10") : (t.style.display = "none", i.removeAttribute("required"), i.removeAttribute("min"), i.value = "0") }) } else if ("multiple-choice" === t.target.value) { n.innerHTML = '\n                        <label>نص السؤال:</label>\n                        <input type="text" class="question-text" required>\n                        <label style="display: flex; align-items: center; gap: 8px;">\n                            <input type="checkbox" class="question-has-points" checked>\n                            <span>هذا السؤال مع نقاط</span>\n                        </label>\n                        <div class="points-container">\n                            <label>النقاط (افتراضي: 10):</label>\n                            <input type="number" class="question-points" value="10" required>\n                        </div>\n                        <div class="options">\n                            <label>الخيار 1:</label><input type="text" class="option" required>\n                            <label>الخيار 2:</label><input type="text" class="option" required>\n                            <label>الخيار 3:</label><input type="text" class="option" required>\n                            <label>الخيار 4:</label><input type="text" class="option" required>\n                        </div>\n                        <label>الإجابة الصحيحة:</label>\n                        <select class="correct-answer">\n                            <option value="1">الخيار 1</option>\n                            <option value="2">الخيار 2</option>\n                            <option value="3">الخيار 3</option>\n                            <option value="4">الخيار 4</option>\n                        </select>\n                    '; const e = n.querySelector(".question-has-points"), t = n.querySelector(".points-container"), i = t.querySelector(".question-points"); e.addEventListener("change", e => { e.target.checked ? (t.style.display = "block", i.required = !0, i.setAttribute("min", "1"), i.value = i.value || "10") : (t.style.display = "none", i.removeAttribute("required"), i.removeAttribute("min"), i.value = "0") }) } }), e.querySelector(".remove-question").addEventListener("click", () => { a.removeChild(e) }), a.appendChild(e) }), i && i.addEventListener("submit", async e => { if (e.preventDefault(), document.querySelectorAll(".question-points").forEach(e => { const t = e.closest(".points-container"); t && "none" === t.style.display && (e.removeAttribute("required"), e.value = "0") }), 0 === document.querySelectorAll(".question").length) return void Swal.fire({ text: "لا يمكن إنشاء نموذج بدون سؤال واحد على الأقل", icon: "error", confirmButtonText: "حسنًا" }); const t = document.getElementById("topic").value.trim(), n = document.getElementById("description").value.trim(), o = document.getElementById("expiry").value, r = Array.from(document.querySelectorAll(".question")).map(e => { const t = e.querySelector(".question-text").value, n = e.querySelector(".question-type").value, i = Array.from(e.querySelectorAll(".option")).map(e => e.value); let a = e.querySelector(".correct-answer").value; const o = e.querySelector(".question-points"), s = e.querySelector(".question-has-points"), l = s && !s.checked || !o ? 0 : parseInt(o.value, 10) || 10; return "multiple-choice" === n && (a = parseInt(a, 10) - 1), { questionText: t, questionType: n, options: i, correctAnswer: a, points: l } }), c = i.querySelector('button[type="submit"]'); c && (c.disabled = !0, c.innerHTML = '<span class="loading-dots" aria-hidden="true"><span></span><span></span><span></span></span><span style="margin-right:8px">جاري الإنشاء...</span>'); try { const e = await fetch("/api/forms", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ topic: t, description: n || "", expiry: o || null, questions: r, targetGrade: l ? l.value : "all", status: "published", allowRetake: !1 }) }); if (e.ok) { const { form: t } = await e.json(); localStorage.removeItem(b), i && i.reset(), a && (a.innerHTML = ""), Swal.fire({ text: "تم إنشاء النموذج!.", icon: "success", confirmButtonText: "حسنًا" }), g(), s ? w() : window.location.reload() } else Swal.fire({ text: "خطأ في إنشاء النموذج. تحقق من اسم الموضوع أو حاول مرة أخرى.", icon: "error", confirmButtonText: "حسنًا" }) } finally { c && (c.disabled = !1, c.innerHTML = "إنشاء النموذج") } }), window.reactivateForm = async function (e, t) { const { value: n } = await Swal.fire({ title: "إعادة تفعيل النموذج", html: '\n        <div style="text-align: center;">\n          <p style="margin-bottom:10px;">اختر تاريخ ووقت انتهاء جديد للنموذج.</p>\n          <input id="newExpiry" type="datetime-local" class="swal2-input" required>\n          <small style="display:block;margin-top:8px;color:#ccc;">\n            سيتم نشر النموذج مرة أخرى فور الحفظ.\n          </small>\n        </div>\n      ', showCancelButton: !0, confirmButtonText: "حفظ وإعادة التفعيل", cancelButtonText: "إلغاء", confirmButtonColor: "#27ae60", cancelButtonColor: "#666", didOpen: () => { const e = document.getElementById("newExpiry"), t = new Date; t.setHours(t.getHours() + 24), e.value = t.toISOString().slice(0, 16) }, preConfirm: () => document.getElementById("newExpiry").value || (Swal.showValidationMessage("يرجى إدخال تاريخ انتهاء صالح"), !1) }); if (n) try { t && (t.disabled = !0, t.innerHTML = '<span class="loading-dots" aria-hidden="true"><span></span><span></span><span></span></span><span style="margin-right:8px">جاري إعادة التفعيل...</span>'); const i = await fetch(`/api/forms/${e}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ expiry: n }) }), a = await i.json().catch(() => ({})); if (!i.ok || !1 === a.success) throw new Error(a.message || "فشل إعادة تفعيل النموذج، يرجى المحاولة مرة أخرى."); await Swal.fire({ title: "تم إعادة التفعيل", text: "تم إعادة تفعيل النموذج وتحديث تاريخ الانتهاء.", icon: "success", confirmButtonText: "حسناً", confirmButtonColor: "#ffcc00" }), w() } catch (i) { Swal.fire({ title: "خطأ!", text: i.message || "تعذر إعادة تفعيل النموذج", icon: "error", confirmButtonText: "حسناً" }) } finally { t && (t.disabled = !1, t.innerHTML = '<i class="fas fa-redo"></i> إعادة تفعيل') } }, window.copyFormLink = function (e) { const t = `${window.location.origin}/form/${e}`; navigator.clipboard.writeText(t).then(() => { Swal.fire({ title: "تم النسخ!", text: "تم نسخ رابط النموذج بنجاح", icon: "success", confirmButtonText: "حسناً", confirmButtonColor: "#ffcc00" }) }).catch(e => { Swal.fire({ title: "خطأ!", text: "تعذر نسخ الرابط", icon: "error", confirmButtonText: "حسناً" }) }) }, window.deactivateForm = async function (e, t) { const n = "string" == typeof e ? e.trim() : ""; if (n) { if ((await Swal.fire({ title: "تعطيل النموذج", text: "هل أنت متأكد أنك تريد تعطيل هذا النموذج؟ سيتم تعطيله وتحديد تاريخ انتهائه إلى تاريخ سابق.", icon: "warning", showCancelButton: !0, confirmButtonText: "نعم، عطل النموذج", cancelButtonText: "إلغاء", confirmButtonColor: "#f39c12", cancelButtonColor: "#666" })).isConfirmed) try { t && "function" == typeof setButtonLoading ? setButtonLoading(t, !0, "جاري التعطيل...") : t && (t.disabled = !0, t.innerHTML = '<span class="loading-dots" aria-hidden="true"><span></span><span></span><span></span></span><span style="margin-right:8px">جاري التعطيل...</span>'); const e = await fetch(`/api/forms/${encodeURIComponent(n)}/deactivate`, { method: "POST", headers: { "Content-Type": "application/json" }, credentials: "include" }), i = await e.json(); if (!e.ok) throw new Error(i.message || "فشل تعطيل النموذج"); await Swal.fire({ title: "تم التعطيل", text: i.message || "تم تعطيل النموذج بنجاح. سيتم تحديث الصفحة تلقائيًا.", icon: "success", confirmButtonText: "حسنًا", confirmButtonColor: "#2ecc71", timer: 2e3, timerProgressBar: !0, willClose: () => { window.location.reload() } }) } catch (i) { await Swal.fire({ title: "خطأ", text: i.message || "حدث خطأ أثناء محاولة تعطيل النموذج. يرجى المحاولة مرة أخرى لاحقًا.", icon: "error", confirmButtonText: "حسنًا", confirmButtonColor: "#e74c3c" }) } finally { t && "function" == typeof setButtonLoading ? setButtonLoading(t, !1) : t && (t.disabled = !1, t.innerHTML = '<i class="fas fa-eye-slash"></i> تعطيل') } } else await Swal.fire({ title: "خطأ", text: "معرّف النموذج غير متوفر.", icon: "error", confirmButtonText: "حسنًا" }) }, async function () { try { const e = await fetch("/api/user-info", { credentials: "include" }), t = await e.json(); if (!t.isAuthenticated) return void (window.location.href = "/login"); if (m && (m.textContent = t.username), p && (p.textContent = "leadadmin" === t.role ? "ليد أدمن" : "admin" === t.role ? "أدمن" : t.role, p.className = "role-badge role-" + (t.role || "admin")), y && (y.textContent = t.username), v) { const e = { leadadmin: "القائد العام", admin: "مسؤول النظام", teacher: "قائد صف", student: "طالب" }; v.textContent = e[t.role] || t.role } return document.querySelectorAll("[data-nav-access]").forEach(function (e) { const n = e.getAttribute("data-nav-access"); e.style.display = t[n] ? "" : "none" }), t } catch (e) { throw e } }().then(() => { s && w() }).catch(e => { s && w() }), window.toggleMenu = function () { f && (f.style.display = "block" === f.style.display ? "none" : "block") }, u && u.addEventListener("click", E), d && d.addEventListener("click", E), document.addEventListener("click", e => { if (!f) return; const t = document.querySelector(".user-display"); f.contains(e.target) || t && t.contains(e.target) || (f.style.display = "none") }) }), "undefined" != typeof window && void 0 === window.deactivateForm && (window.deactivateForm = function (e, t) { });